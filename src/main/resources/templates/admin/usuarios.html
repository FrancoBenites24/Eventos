<section>
    <h2 class="mb-4">Gestión de Usuarios</h2>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Nombre</th>
                        <th>Apellido</th>
                        <th>Email</th>
                        <th>Roles</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="u : ${usuarios}">
                        <td th:text="${u.username}">usuario</td>
                        <td th:text="${u.nombre}">nombre</td>
                        <td th:text="${u.apellido}">apellido</td>
                        <td th:text="${u.email}">correo@example.com</td>
                        <td>
                            <span th:each="ur : ${u.usuarioRoles}" 
                                  th:text="${ur.rol.nombre}" 
                                  class="badge bg-primary me-1">Rol</span>
                        </td>
                        <td class="text-center">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light border" type="button" data-bs-toggle="dropdown">
                                    <i class="fa fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item ver-detalles" th:attr="data-id=${u.id}">
                                            <i class="fa fa-eye me-2"></i> Ver detalles
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item editar-usuario" th:attr="data-id=${u.id}">
                                            <i class="fa fa-edit me-2"></i> Editar
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item asignar-roles" th:attr="data-id=${u.id}">
                                            <i class="fa fa-user-shield me-2"></i> Asignar roles
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item disabled" href="#">
                                            <i class="fa fa-trash me-2"></i> Eliminar (deshabilitado)
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ver Detalles -->
    <div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detallesModalLabel">Detalles del Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Username:</strong> <span id="detalles-username"></span></p>
                            <p><strong>Nombre:</strong> <span id="detalles-nombre"></span></p>
                            <p><strong>Apellido:</strong> <span id="detalles-apellido"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong> <span id="detalles-email"></span></p>
                            <p><strong>Teléfono:</strong> <span id="detalles-telefono"></span></p>
                            <p><strong>Fecha de Creación:</strong> <span id="detalles-creadoEn"></span></p>
                        </div>
                    </div>
                    <hr>
                    <h6>Roles Asignados:</h6>
                    <div id="detalles-roles"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-id" name="id">
                        <div class="mb-3">
                            <label for="edit-nombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="edit-nombre" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-apellido" class="form-label">Apellido</label>
                            <input type="text" class="form-control" id="edit-apellido" name="apellido" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-telefono" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="edit-telefono" name="telefono" pattern="[0-9]{9}" title="9 dígitos">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitEdit()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Asignar Roles -->
    <div class="modal fade" id="rolesModal" tabindex="-1" aria-labelledby="rolesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="rolesModalLabel">Asignar Roles</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="roles-user-id">
                    <div id="roles-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="submitRoles()">Guardar Roles</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const csrfToken = document.querySelector('meta[name="_csrf"]') ? document.querySelector('meta[name="_csrf"]').getAttribute('content') : '';
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]') ? document.querySelector('meta[name="_csrf_header"]').getAttribute('content') : 'X-CSRF-TOKEN';

            // Ver detalles
            document.querySelectorAll('.ver-detalles').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    fetch(`/admin/usuarios/${id}/detalles`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(user => {
                        document.getElementById('detalles-username').textContent = user.username;
                        document.getElementById('detalles-nombre').textContent = user.nombre;
                        document.getElementById('detalles-apellido').textContent = user.apellido;
                        document.getElementById('detalles-email').textContent = user.email;
                        document.getElementById('detalles-telefono').textContent = user.telefono || 'No especificado';
                        document.getElementById('detalles-creadoEn').textContent = new Date(user.creadoEn).toLocaleString();

                        const rolesDiv = document.getElementById('detalles-roles');
                        rolesDiv.innerHTML = '';
                        if (user.usuarioRoles && user.usuarioRoles.length > 0) {
                            user.usuarioRoles.forEach(ur => {
                                const span = document.createElement('span');
                                span.className = 'badge bg-primary me-1';
                                span.textContent = ur.rol.nombre;
                                rolesDiv.appendChild(span);
                            });
                        } else {
                            rolesDiv.innerHTML = '<p>No hay roles asignados.</p>';
                        }

                        new bootstrap.Modal(document.getElementById('detallesModal')).show();
                    })
                    .catch(error => console.error('Error:', error));
                });
            });

            // Editar usuario
            document.querySelectorAll('.editar-usuario').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    fetch(`/admin/usuarios/${id}/edit`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(user => {
                        document.getElementById('edit-id').value = user.id;
                        document.getElementById('edit-nombre').value = user.nombre;
                        document.getElementById('edit-apellido').value = user.apellido;
                        document.getElementById('edit-email').value = user.email;
                        document.getElementById('edit-telefono').value = user.telefono || '';

                        new bootstrap.Modal(document.getElementById('editModal')).show();
                    })
                    .catch(error => console.error('Error:', error));
                });
            });

            // Asignar roles
            document.querySelectorAll('.asignar-roles').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const id = this.getAttribute('data-id');
                    document.getElementById('roles-user-id').value = id;
                    fetch(`/admin/usuarios/${id}/roles`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        const rolesList = document.getElementById('roles-list');
                        rolesList.innerHTML = '';
                        data.allRoles.forEach(rol => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'form-check-input';
                            checkbox.id = 'rol-' + rol.id;
                            checkbox.value = rol.id;
                            checkbox.name = 'roles';
                            const checked = data.userRoles.some(ur => ur.id === rol.id);
                            checkbox.checked = checked;
                            const label = document.createElement('label');
                            label.className = 'form-check-label';
                            label.htmlFor = 'rol-' + rol.id;
                            label.textContent = rol.nombre;
                            div.appendChild(checkbox);
                            div.appendChild(label);
                            rolesList.appendChild(div);
                        });

                        new bootstrap.Modal(document.getElementById('rolesModal')).show();
                    })
                    .catch(error => console.error('Error:', error));
                });
            });

            window.submitEdit = function() {
                const id = document.getElementById('edit-id').value;
                const formData = {
                    id: id,
                    nombre: document.getElementById('edit-nombre').value,
                    apellido: document.getElementById('edit-apellido').value,
                    email: document.getElementById('edit-email').value,
                    telefono: document.getElementById('edit-telefono').value
                };

                fetch(`/admin/usuarios/${id}/update`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            };

            window.submitRoles = function() {
                const id = document.getElementById('roles-user-id').value;
                const checkboxes = document.querySelectorAll('#roles-list input[type="checkbox"]:checked');
                const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

                fetch(`/admin/usuarios/${id}/roles`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(selectedIds)
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            };
        });
    </script>
</section>
