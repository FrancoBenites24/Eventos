<!DOCTYPE html>
<html lang="es" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Perfil</title>

  <!-- Bootstrap y Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Estilos personalizados -->
  <link rel="stylesheet" th:href="@{/css/main.css}">

  <style>
    .progress-animated {
      transition: width 1s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav th:replace="fragments/navbar :: navbar"></nav>

  <main class="container app-container pb-5 mt-4">
    <div class="row g-4">
      <!-- Columna izquierda -->
      <div class="col-12 col-lg-4">
        <!-- Información del usuario -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <div class="position-relative">
                <img th:src="${perfil != null and perfil.fotoPerfil != null ? perfil.fotoPerfil : 'https://via.placeholder.com/80'}"
                     class="rounded-circle border border-2 border-white shadow-sm"
                     alt="Foto de perfil" width="80" height="80">
                <span th:if="${perfil != null and perfil.verificado}"
                      class="position-absolute bottom-0 end-0 badge bg-success rounded-circle p-2"
                      title="Verificado">
                  <i class="bi bi-check-lg"></i>
                </span>
              </div>
              <div class="ms-3">
                <h4 class="mb-0"
                    th:text="${!#strings.isEmpty(nombreCompleto) ? nombreCompleto : (perfil != null and perfil.username != null ? perfil.username : 'Usuario')}">
                  Usuario
                </h4>
                <p class="text-muted small mb-0"
                   th:text="${perfil != null and !#strings.isEmpty(perfil.email) ? perfil.email : 'correo@ejemplo.com'}">
                  correo@ejemplo.com
                </p>
                <span th:if="${perfil != null and perfil.miembro}" class="badge bg-primary mt-1">Miembro</span>
              </div>
            </div>
            <div class="d-flex gap-2">
              <a th:href="@{/perfil/editar}" class="btn btn-sm btn-outline-primary flex-fill">
                <i class="bi bi-pencil-square me-1"></i> Editar perfil
              </a>
              <button class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Billetera -->
        <div class="card shadow-sm">
          <div class="card-header bg-white py-3">
            <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>Billetera</h5>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <span class="text-muted">Saldo disponible</span>
              <h3 class="mb-0"
                  th:text="'S/ ' + ${#numbers.formatDecimal(perfil != null and perfil.saldo != null ? perfil.saldo : 0.0, 1, 2)}">
                S/ 0.00
              </h3>
            </div>

            <h6 class="text-muted mb-3">Transacciones recientes</h6>
            <div class="d-flex flex-column gap-3">
              <!-- Iteración -->
              <div th:if="${perfil != null and perfil.movimientosRecientes != null and !#lists.isEmpty(perfil.movimientosRecientes)}"
                   th:each="movimiento : ${perfil.movimientosRecientes}" class="d-flex align-items-center">
                <div class="rounded-circle bg-light p-2 me-3">
                  <i th:class="${movimiento.tipo == 'recarga' ? 'bi bi-arrow-down-circle text-success' :
                                (movimiento.tipo == 'compra' ? 'bi bi-arrow-up-circle text-danger' : 'bi bi-arrow-left-right text-primary')}"></i>
                </div>
                <div class="flex-grow-1">
                  <p class="mb-0 small fw-medium"
                     th:text="${!#strings.isEmpty(movimiento.descripcion) ? movimiento.descripcion : movimiento.tipo}">
                    Transacción
                  </p>
                  <p class="mb-0 text-muted small"
                     th:text="${movimiento.creadoEn != null ? #temporals.format(movimiento.creadoEn, 'dd/MM/yyyy HH:mm') : 'Fecha desconocida'}">
                    Fecha
                  </p>
                </div>
                <span th:class="${movimiento.tipo == 'recarga' ? 'text-success' :
                                 (movimiento.tipo == 'compra' ? 'text-danger' : 'text-primary')}"
                      th:text="${(movimiento.tipo == 'recarga' ? '+' : (movimiento.tipo == 'compra' ? '-' : '')) + 'S/ ' + #numbers.formatDecimal(movimiento.monto != null ? movimiento.monto : 0.0, 1, 2)}">
                  Monto
                </span>
              </div>

              <!-- Mensaje si no hay movimientos -->
              <div th:if="${perfil == null or perfil.movimientosRecientes == null or #lists.isEmpty(perfil.movimientosRecientes)}"
                   class="text-center text-muted py-3">
                <p class="mb-0">No hay transacciones recientes</p>
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Recargar saldo
              </button>
              <button class="btn btn-outline-secondary">
                <i class="bi bi-clock-history me-1"></i> Ver historial
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Columna derecha -->
      <div class="col-12 col-lg-8">
        <!-- Información Personal -->
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-white py-3">
            <h5 class="mb-0"><i class="bi bi-person-vcard me-2"></i>Información Personal</h5>
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-12 col-md-6 mb-3 mb-md-0">
                <label class="text-muted small">Nombre completo</label>
                <p class="mb-0 fw-medium"
                   th:text="${!#strings.isEmpty(nombreCompleto) ? nombreCompleto : (perfil != null and perfil.username != null ? perfil.username : 'Usuario')}">Usuario</p>
              </div>
              <div class="col-12 col-md-6">
                <label class="text-muted small">Correo electrónico</label>
                <p class="mb-0 fw-medium"
                   th:text="${perfil != null and !#strings.isEmpty(perfil.email) ? perfil.email : 'correo@ejemplo.com'}">correo@ejemplo.com</p>
              </div>
            </div>

            <div class="mb-3">
              <label class="text-muted small">Biografía</label>
              <p class="mb-0"
                 th:text="${!#strings.isEmpty(biografia) ? biografia : 'Sin biografía'}">Sin biografía</p>
            </div>

            <div class="card bg-light">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <span class="fw-medium">Puntos de lealtad</span>
                  <span class="badge bg-primary"
                        th:text="${perfil != null and perfil.puntos != null ? perfil.puntos + ' pts' : '0 pts'}">0 pts</span>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <small class="text-muted">Nivel actual</small>
                  <span class="badge bg-secondary"
                        th:text="${perfil != null and perfil.nivel != null ? 'Nivel ' + perfil.nivel : 'Nivel 0'}">Nivel 0</span>
                </div>
                <div class="progress mb-1" style="height: 10px;">
                  <div id="progressBar" class="progress-bar bg-success progress-animated" role="progressbar"
                       th:style="'width:' + ((perfil != null and perfil.puntos != null ? perfil.puntos : 0) * 100 / ((perfil != null and perfil.puntos != null ? perfil.puntos : 0) + (perfil != null and perfil.puntosParaSiguienteNivel != null ? perfil.puntosParaSiguienteNivel : 40))) + '%'"
                       th:attr="aria-valuenow=${perfil != null and perfil.puntos != null ? perfil.puntos : 0},
                                aria-valuemax=${(perfil != null and perfil.puntos != null ? perfil.puntos : 0) + (perfil != null and perfil.puntosParaSiguienteNivel != null ? perfil.puntosParaSiguienteNivel : 40)}"
                       aria-valuemin="0">
                  </div>
                </div>
                <small class="text-muted"
                       th:text="'Necesitas ' + (perfil != null and perfil.puntosParaSiguienteNivel != null ? perfil.puntosParaSiguienteNivel : 40) + ' puntos para subir de nivel'">
                  Necesitas 40 puntos para subir de nivel
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Próximos Eventos -->
        <div class="card shadow-sm">
          <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-calendar-event me-2"></i>Próximos Eventos</h5>
            <a href="#" class="btn btn-sm btn-outline-primary">Ver todos</a>
          </div>
          <div class="card-body">
            <div th:if="${perfil == null or perfil.proximosEventos == null or #lists.isEmpty(perfil.proximosEventos)}"
                 class="alert alert-info mb-3" role="alert">
              <i class="bi bi-info-circle me-2"></i>No tienes próximos eventos. Compra entradas para eventos y aparecerán aquí.
            </div>

            <!-- Lista de eventos -->
            <div th:if="${perfil != null and perfil.proximosEventos != null and !#lists.isEmpty(perfil.proximosEventos)}" class="list-group">
              <div th:each="evento : ${perfil.proximosEventos}" class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h5 class="mb-1"
                      th:text="${!#strings.isEmpty(evento.titulo) ? evento.titulo : 'Evento sin título'}">Evento</h5>
                  <small th:text="${evento.fechaInicio != null ? #temporals.format(evento.fechaInicio, 'dd/MM/yyyy HH:mm') : 'Fecha no definida'}">Fecha</small>
                </div>
                <p class="mb-1"
                   th:text="${!#strings.isEmpty(evento.descripcion) ? evento.descripcion : 'Sin descripción'}">Descripción</p>
                <div class="d-flex gap-2">
                  <a th:href="@{/detalle-evento/{id}(id=${evento.id})}" class="btn btn-sm btn-primary">
                    Ver detalles
                  </a>
                  <button class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-share"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje si el perfil es nulo -->
    <div th:if="${perfil == null}" class="alert alert-danger mt-3">
      <i class="bi bi-exclamation-triangle me-2"></i>
      No se pudo cargar la información del perfil. Por favor, inténtalo de nuevo más tarde.
    </div>
  </main>

  <!-- Footer -->
  <footer th:replace="fragments/footer :: footer"></footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script para animar la barra de progreso -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const progressBar = document.getElementById('progressBar');
      if (progressBar) {
        const now = parseInt(progressBar.getAttribute('aria-valuenow')) || 0;
        const max = parseInt(progressBar.getAttribute('aria-valuemax')) || 100;
        const percentage = Math.round((now / max) * 100);
        progressBar.style.width = '0%';
        setTimeout(() => {
          progressBar.style.width = percentage + '%';
        }, 300);
      }
    });
  </script>
</body>
</html>
